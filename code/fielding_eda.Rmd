---
title: "Lahman Fielding EDA"
runtime: shiny
output: html_document
---

<!-- # ```{r setup, include=FALSE} -->
<!-- # knitr::opts_chunk$set(echo = TRUE) -->
<!-- # ``` -->

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Check for required packages
#required <- c("RODBC", "ggplot2")
# installed <- names(installed.packages()[, "Package"])
# matches <- match(needed, installed)

# for (i in required) {
#   if(!require(i)){
#     print(paste("Loading ", i))
#     install.packages(i)
#   }
#   library(i)
# }


library(RODBC)
library(ggplot2)


query = "SELECT f.playerID
            ,f.yearID
            ,max(f.stint) as num_stints
            ,count(f.POS) as num_positions
            ,sum(coalesce(f.G, 0)) as games
            ,sum(coalesce(f.GS, 0)) as games_started
            ,sum(coalesce(f.InnOuts, 0)) as outs_played
            ,sum(coalesce(f.PO, 0)) as put_outs
            ,sum(coalesce(f.A, 0)) as assists
            ,sum(coalesce(f.E, 0)) as errors
            ,sum(coalesce(f.DP, 0)) as double_plays
            ,sum(coalesce(f.PB, 0)) as passed_balls
            ,sum(coalesce(f.WP, 0)) as wild_pitches
            ,sum(coalesce(f.SB, 0)) as opponent_stolen_bases
            ,sum(coalesce(f.CS, 0)) as opponent_caught_stealing
            ,sum(coalesce(f.ZR, 0)) as zone_rating
            ,max(case when f.POS = 'C' then 1 else 0 end) as is_catcher
            ,max(case when f.POS = 'P' then 1 else 0 end) as is_pitcher
            ,max(case when ap.awardID is null then 0 else 1 end) as won_gg
        FROM Fielding as f
        left join AwardsPlayers as ap 
          on f.playerID = ap.playerID
          and f.yearID = ap.yearID
          and ap.awardID = 'Gold Glove'
        where f.yearID >= 1957
        group by f.playerID, f.yearID"

plot_histogram <- function(var, df,  bw = 1, x_max = NULL) {
  
  x_max <- if (is.null(x_max)) {max(df[toString(var)])} else {x_max}
  
  ggplot(aes_string(x = toString(var)), data = df) +
    geom_histogram(binwidth = bw, color = "black", fill = "#099DD9") +
    geom_vline(aes(xintercept=median(df[[toString(var)]]),
               color = "median"), linetype="solid", size=1) +
    geom_vline(aes(xintercept=mean(df[[toString(var)]]),
               color = "mean"), linetype="solid", size=1) +    
    scale_color_manual(name  = "Summary Stats", values=c(median = "blue", mean = "red")) +
    scale_x_continuous(breaks = seq(0, x_max, bw), minor_breaks = NULL) +
    theme(axis.text.x = element_text(angle=90))
  
}

dbhandle <- if (Sys.info()['nodename'] == "FD63STA001756") {
  
  odbcDriverConnect('driver={SQL Server};server=FD63STA001756\\JAC2;database=lahman;trusted_connection=true')

} else {
     
  odbcDriverConnect('driver={SQL Server};server=DESKTOP-PM6C8DF\\SQLEXPRESS;database=lahman;trusted_connection=true')

}

res <- sqlQuery(dbhandle, query)
res$labels = factor(res$won_gg, levels = c("0", "1"), labels = c("Population", "Gold Glove Winners"))
```




```{r echo=FALSE}
#summary(res[[var]])
```


```{r echo = FALSE}

fielding_stats <- c("num_stints", "num_positions", "games", "games_started", "outs_played", "put_outs",
                    "assists", "errors", "double_plays", "passed_balls", "wild_pitches", "opponent_stolen_bases",
                    "opponent_caught_stealing", "zone_rating")

selectInput("f_stat", label = "Select fielding stat", choices = fielding_stats, selected = "assists")


checkboxInput("year_range", label = "Multi Year", value = FALSE)

conditionalPanel(condition = "input.year_range",
                 sliderInput("years", label = "Select Year Range", min  = min(res$yearID), max = max(res$yearID),
                 value = c(2000, 2016), step = 1, sep = ""))

conditionalPanel(condition = "!input.year_range",
                 selectInput("year", label = "Select Year", choices = seq(min(res$yearID), max(res$yearID)),
                             selected = 2000))

sliderInput("bin_width", label = "Select Bin Width", min = 1, max = 100, value = c(10), step = 1)



```


## Popluation
```{r echo = FALSE}

renderPlot({
  
  df_in <- if (input$year_range) {
    
            subset(res, yearID >= input$years[1] & yearID <= input$years[2])
            
          } else {
            
            subset(res, yearID == input$year)
            
          }
  
  plot_histogram(input$f_stat, df_in, input$bin_width)
  
})

```

## Gold Glove Winners
```{r echo = FALSE}

renderPlot({
  
  df_in <- if (input$year_range) {
    
            subset(res, yearID >= input$years[1] & yearID <= input$years[2])
            
          } else {
            
            subset(res, yearID == input$year)
            
          }  
  
  pop_max <- max(subset(df_in, won_gg == 1, select = input$f_stat))

  plot_histogram(input$f_stat, df_in[df_in$won_gg == 1,], input$bin_width, pop_max)

})

```




```{r echo=FALSE}
#summary(res[res$won_gg == 1, var])
```
```{r echo=FALSE}
#plot_histogram(var, res[res$won_gg == 1,], bw)

```




